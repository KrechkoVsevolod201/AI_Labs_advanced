# Лабораторная работа №4: Диффузионные модели (DDPM, Stable Diffusion)

## Цель
Изучить принципы работы диффузионных моделей на примере **Stable Diffusion** и **DDPM**, научиться управлять процессом генерации, 
визуализировать прямой и обратный процессы диффузии, а также исследовать влияние ключевых гиперпараметров.

## Реализация

### Часть 1. Stable Diffusion  
- Использована предобученная модель `runwayml/stable-diffusion-v1-5` через библиотеку `diffusers`.  
- Проведены эксперименты с различными промптами и параметрами (`guidance_scale`, `num_inference_steps`).  
- Получены иллюстрации, демонстрирующие влияние `guidance_scale` на соответствие изображения текстовому описанию и детализацию.
- Обнаружен прикол, что на неоднозначные запросы, модель может создавать нецензурный контент, но в модель встроена защита и она возвращает чёрный квадрат в таких ситуациях

### Часть 2. DDPM  
- Реализована упрощённая архитектура `ContextUnet` с поддержкой класс-условной генерации.  
- На начальном этапе использовался датасет **CIFAR-10**, однако из-за его цветности, более высокой сложности и малого разрешения (32×32), требовалась более длительная настройка гиперпараметров и существенно больше эпох для устойчивой сходимости.  
- Для ускорения итеративного цикла отладки и обеспечения стабильного обучения был выбран датасет **MNIST** — простой, чёрно-белый, с чёткими семантическими классами, что позволило быстро оценить корректность реализации и визуализировать динамику диффузии.

- Реализованы:
  - Прямой процесс: постепенное добавление шума к изображению.
  - Обратный процесс: пошаговое восстановление изображения из шума.
  - Визуализации на ключевых шагах (`t = T, T/2, T/4, 1, 0`).
- Обучение проводилось на NVIDIA GPU (CUDA), использовались фиксированные seed’ы для воспроизводимости.

## Выводы
- Диффузионные модели гибко управляются через промпты и параметры инференса (в отличие от GAN).
- Качество генерации сильно зависит от числа шагов и коэффициента guidance: слишком высокие значения могут вызывать артефакты или NSFW-фильтрацию.
- Для исследовательских задач и быстрого прототипирования проще начинать с простых датасетов (например, MNIST), и только затем масштабироваться на CIFAR-10, Fashion-MNIST и т.д.

## Дополнительно: дообучение и тонкая настройка моделей  
Помимо программного подхода в Colab, удобным инструментом для экспериментов с диффузионными моделями является [**Stability Matrix**](https://github.com/LykosAI/StabilityMatrix). Ранее его использовал, инструмент очень хороший и гибкий, вот пара примеров моих генераций

<img width="896" height="1152" alt="image" src="https://github.com/user-attachments/assets/27e5013a-eb6e-408f-a494-2150845f782a" />

<img width="896" height="1152" alt="image" src="https://github.com/user-attachments/assets/4da5c006-1b77-422e-a3ee-d31db568f614" />
